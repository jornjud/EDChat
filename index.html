<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3in1 Key-Emoji-Spinner (Dark Mode)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KZ1W13YWND"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KZ1W13YWND');
      // gtag('config', 'G-GRGVJ1V7BX'); // Measurement ID ‡∏à‡∏≤‡∏Å Firebase config
    </script>
    <style>
        /* Custom styles for toast and modal (can be refined further) */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevent pull-to-refresh */
        }
        .toast-notification {
            position: fixed;
            bottom: 20px; /* Adjusted for mobile */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(50, 50, 50, 0.9); /* Darker toast */
            color: #fff;
            padding: 10px 20px;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.9rem;
            z-index: 10000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            animation: fadeInOutToast 2.5s ease-in-out forwards;
            transition: opacity 0.3s ease;
        }
        .toast-notification.error {
             background-color: rgba(239, 68, 68, 0.9); /* Red for errors */
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            animation: fadeInModal 0.3s ease-out;
        }
        .modal-content {
            background-color: #2d3748; /* Dark background for modal */
            color: #e2e8f0; /* Light text */
            margin: 15% auto; /* Center vertically */
            padding: 20px;
            border-radius: 0.75rem; /* Rounded corners */
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: slideInModal 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .modal-content h2 { color: #63b3ed; } /* Light blue heading */
        #helpContent code { background-color: #4a5568; color: #fed7d7; padding: 2px 5px; border-radius: 4px; }
        #helpContent div { border-bottom: 1px solid #4a5568; }
        .close-btn {
            color: #a0aec0;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px; /* Slightly smaller */
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-btn:hover { color: #fff; }

        /* Animations */
        @keyframes fadeInModal { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideInModal { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        @keyframes fadeInOutToast {
            0% { opacity: 0; bottom: -50px; } /* Start from below */
            10% { opacity: 1; bottom: 20px; }
            90% { opacity: 1; bottom: 20px; }
            100% { opacity: 0; bottom: -50px; } /* Fade out downwards */
        }

        /* Tailwind Config (Optional: for custom theme colors if needed) */
        /*
        tailwind.config = {
          darkMode: 'class', // or 'media'
          theme: {
            extend: {
              colors: {
                // Define custom dark theme colors here
              }
            }
          }
        }
        */
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-full flex flex-col items-center justify-center p-4">

    <div id="auth-container" class="w-full max-w-md p-6 md:p-8 bg-gray-800 rounded-xl shadow-lg">
        <h1 class="text-xl md:text-2xl font-bold text-center text-blue-400 mb-2">üîê ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏î‡∏¥‡∏ß‡∏∞ ‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™!üîê</h1>
        <p class="text-center text-gray-400 text-sm mb-6">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏°‡∏∂‡∏á!</p>

        <div id="login-form" class="mb-6">
            <h2 class="text-lg font-semibold text-center mb-4 flex items-center justify-center gap-2"><i class="fas fa-user text-blue-400"></i> Login ‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™!</h2>
            <div class="mb-4">
                <label for="login-username" class="block text-sm font-medium text-gray-300 mb-1">Username ‡∏´‡∏£‡∏∑‡∏≠ Email:</label>
                <input type="text" id="login-username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Username ‡∏´‡∏£‡∏∑‡∏≠ Email..." required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            <div class="mb-4">
                <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
                <input type="password" id="login-password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô..." required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 ease-in-out flex items-center justify-center gap-2 text-sm"><i class="fas fa-check"></i> ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡∏¥‡πÄ‡∏´‡∏µ‡πâ‡∏¢!</button>
        </div>

        <hr class="border-gray-600 my-6">

        <div id="register-form">
            <h2 class="text-lg font-semibold text-center mb-4 flex items-center justify-center gap-2"><i class="fas fa-user-plus text-green-400"></i> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏´‡∏£‡∏≠‡∏ß‡∏∞?</h2>
            <div class="mb-4">
                <label for="register-username" class="block text-sm font-medium text-gray-300 mb-1">Username:</label>
                <input type="text" id="register-username" placeholder="‡∏ï‡∏±‡πâ‡∏á Username (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡πÄ‡∏•‡∏Ç, 3 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
            </div>
            <div class="mb-4">
                <label for="register-email" class="block text-sm font-medium text-gray-300 mb-1">Email:</label>
                <input type="email" id="register-email" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡∏µ‡∏™‡∏±‡∏™!)" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
            </div>
            <div class="mb-4">
                <label for="register-password" class="block text-sm font-medium text-gray-300 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
                <input type="password" id="register-password" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
            </div>
            <button id="register-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 ease-in-out flex items-center justify-center gap-2 text-sm"><i class="fas fa-plus-circle"></i> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÇ‡∏ß‡πâ‡∏¢!</button>
        </div>

        <p id="auth-error" class="text-red-400 text-center mt-4 font-semibold text-sm min-h-[1.2em]"></p>
    </div>

    <div id="app-container" class="w-full h-full max-w-3xl bg-gray-800 rounded-xl shadow-lg p-4 md:p-6 flex flex-col" style="display: none;">

        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <h1 class="text-lg md:text-xl font-bold text-center text-blue-400 flex-grow whitespace-nowrap">üîê 3in1 Key-Emoji-Spinner üîê</h1>
            <div class="flex items-center gap-2 flex-shrink-0">
                <span id="user-display" class="text-xs md:text-sm text-gray-400"></span>
                <button id="logout-button" class="p-2 rounded-full bg-red-600 hover:bg-red-700 text-white transition duration-200 text-xs" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"><i class="fas fa-sign-out-alt"></i></button>
                <button id="helpBtn" class="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition duration-200 text-xs" title="‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"><i class="fas fa-question-circle"></i></button>
            </div>
        </div>

        <div class="mode-instruction text-center text-sm text-gray-400 mb-4 flex items-center justify-center gap-2">
            <i class="fas fa-hand-point-down text-blue-400"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        </div>

        <div class="mode-buttons grid grid-cols-3 gap-2 md:gap-3 mb-4">
             <button id="xorModeBtn" class="mode-btn bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-2 px-3 rounded-lg transition duration-200 text-xs md:text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-center">
                <i class="fas fa-key"></i> <span class="whitespace-nowrap">Key Translator</span>
            </button>
             <button id="emojiModeBtn" class="mode-btn bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-2 px-3 rounded-lg transition duration-200 text-xs md:text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-center">
                <i class="fas fa-smile"></i> <span class="whitespace-nowrap">Emoji Code</span>
            </button>
             <button id="wordSpinnerModeBtn" class="mode-btn bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-2 px-3 rounded-lg transition duration-200 text-xs md:text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-center">
                <i class="fas fa-sync-alt"></i> <span class="whitespace-nowrap">Word Spinner</span>
            </button>
        </div>
        <style> /* Style for active button */
            .mode-btn.active { background-color: #2563eb; color: white; } /* Blue-600 */
        </style>

        <div id="keywordSection" class="keyword-section mb-4" style="display: none;">
            <label for="keywordInput" class="flex items-center gap-2 text-sm font-medium text-gray-300 whitespace-nowrap mr-2"><i class="fas fa-search"></i> Keyword:</label>
            <input type="text" id="keywordInput" placeholder="‡πÉ‡∏™‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î... ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ" class="flex-grow px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent text-sm" />
        </div>

        <div class="io-section flex flex-col gap-3 flex-grow min-h-0">
            <textarea id="inputText" placeholder="üìù ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." class="w-full flex-1 resize-none p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent text-sm min-h-[80px]"></textarea>
            <textarea id="outputText" placeholder="üì§ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." readonly class="w-full flex-1 resize-none p-3 bg-gray-600 border border-gray-500 rounded-md text-gray-300 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent text-sm min-h-[80px]"></textarea>
        </div>

        <div class="action-buttons grid grid-cols-2 gap-2 md:gap-3 mt-4">
            <button id="copyButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex items-center justify-center gap-2 text-sm"><i class="fas fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
            <button id="clearButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex items-center justify-center gap-2 text-sm"><i class="fas fa-trash"></i> ‡∏•‡πâ‡∏≤‡∏á</button>
        </div>

        <div class="video-link text-center text-xs md:text-sm mt-4 text-gray-400">
            üìπ <a href="https://www.youtube.com/watch?v=VIDEO_ID" target="_blank" class="text-blue-400 hover:text-blue-300 hover:underline">‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ...‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô YouTube</a>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">√ó</span>
            <h2 class="text-lg md:text-xl font-semibold text-center mb-4 flex items-center justify-center gap-2"><i class="fas fa-info-circle"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î ü§ì</h2>
            <div id="helpContent" class="text-sm space-y-4">
                </div>
        </div>
    </div>

    <script>
        // ======== Firebase Configuration ========
        const firebaseConfig = {
            apiKey: "AIzaSyB3ZXwlQlNPKEaryal0YnbarwQoz1DjhEE", // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Key ‡∏Ç‡∏≠‡∏á‡∏°‡∏∂‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ
            authDomain: "in1-e0d50.firebaseapp.com",
            projectId: "in1-e0d50",
            storageBucket: "in1-e0d50.appspot.com", // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
            messagingSenderId: "785769870882",
            appId: "1:785769870882:web:42df8ee3b40eced196bc7b",
            measurementId: "G-GRGVJ1V7BX"
        };

        // ======== Initialize Firebase ========
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log("Firebase & Firestore Initialized ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÇ‡∏ß‡πâ‡∏¢!");

        // ======== Element References (Auth + App) ========
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const registerUsernameInput = document.getElementById('register-username');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const registerButton = document.getElementById('register-button');
        const logoutButton = document.getElementById('logout-button');
        const authErrorDisplay = document.getElementById('auth-error');
        const userDisplay = document.getElementById('user-display');
        const xorModeBtn = document.getElementById('xorModeBtn');
        const wordSpinnerModeBtn = document.getElementById('wordSpinnerModeBtn');
        const emojiModeBtn = document.getElementById('emojiModeBtn');
        const keywordSection = document.getElementById('keywordSection');
        const keywordInput = document.getElementById('keywordInput');
        const inputText = document.getElementById('inputText');
        const outputText = document.getElementById('outputText');
        const copyButton = document.getElementById('copyButton');
        const clearButton = document.getElementById('clearButton');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeBtn = helpModal.querySelector('.close-btn');
        const helpContent = document.getElementById('helpContent');

        let currentMode = null;
        let toastTimeout = null;

        // ======== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Toast ========
        function showToast(message, duration = 2500, isError = false) {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) { clearTimeout(toastTimeout); existingToast.remove(); }
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'toast-notification';
            if (isError) { toast.classList.add('error'); } // ‡πÉ‡∏ä‡πâ class 'error'
            document.body.appendChild(toast);

            // Force reflow to enable animation
            toast.offsetHeight;

            toast.style.opacity = '1'; // Make it visible for animation

            toastTimeout = setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                         toast.parentNode.removeChild(toast);
                    }
                }, 300); // Wait for fade out transition
            }, duration - 300);
        }


        // ======== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Error ‡∏Ç‡∏≠‡∏á Auth ========
        function showAuthError(message) {
            let displayMessage = message;
            // ‡πÅ‡∏õ‡∏•‡∏á Error codes ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
            if (message.includes('auth/invalid-email')) { displayMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
            else if (message.includes('auth/user-not-found') || message.includes('auth/invalid-credential')) { displayMessage = 'Username (‡∏´‡∏£‡∏∑‡∏≠ Email) ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
            else if (message.includes('auth/wrong-password')) { displayMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
            else if (message.includes('auth/email-already-in-use')) { displayMessage = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'; }
            else if (message.includes('auth/weak-password')) { displayMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)'; }
            else if (message.includes('auth/missing-password')) { displayMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'; }
            else if (message.includes('auth/missing-email')) { displayMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•'; }
            else if (message.includes('Username check failed') || message.includes('Firestore write failed')) { displayMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Username ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'; }
            else if (message.includes('Username already exists')) { displayMessage = `Username ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß!`; }
            else if (message.includes('Username not found')) { displayMessage = `‡πÑ‡∏°‡πà‡∏û‡∏ö Username ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö!`; }
            else if (message.includes('Invalid Username format')) { displayMessage = `Username ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (a-z), ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (0-9) ‡πÅ‡∏•‡∏∞‡∏Ç‡∏µ‡∏î‡∏•‡πà‡∏≤‡∏á (_) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`; }
            else if (message.includes('Username too short') || message.includes('Username too long')) { displayMessage = `Username ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 3-30 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£`; }

            if(authErrorDisplay) authErrorDisplay.textContent = `üö´ ${displayMessage}`;
            showToast(`üö´ ${displayMessage}`, 4000, true); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô Toast ‡∏î‡πâ‡∏ß‡∏¢
        }

        // ======== Event Listener ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Register ========
        if (registerButton) {
            registerButton.addEventListener('click', async () => {
                if (!registerUsernameInput || !registerEmailInput || !registerPasswordInput) {
                    console.error("Register form inputs not found!");
                    showAuthError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô");
                    return;
                }
                const username = registerUsernameInput.value.trim().toLowerCase();
                const email = registerEmailInput.value.trim();
                const password = registerPasswordInput.value;
                if(authErrorDisplay) authErrorDisplay.textContent = '';

                // Input Validation (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                if (!username || !email || !password) { showAuthError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username, Email, ‡πÅ‡∏•‡∏∞ Password ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); return; }
                const usernameRegex = /^[a-z0-9_]+$/;
                if (!usernameRegex.test(username)) { showAuthError("Invalid Username format"); return; }
                if (username.length < 3 || username.length > 30) { showAuthError("Username too short or Username too long"); return; }
                if (password.length < 6) { showAuthError("auth/weak-password"); return; }

                try {
                    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ Username ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô Firestore
                    console.log(`Checking username: ${username}`);
                    const usernameRef = db.collection('usernames').doc(username);
                    const usernameDoc = await usernameRef.get();
                    if (usernameDoc.exists) {
                        console.log(`Username ${username} already exists.`);
                        showAuthError(`Username already exists`); return;
                    }
                    console.log(`Username ${username} is available.`);

                    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏ô Firebase Auth
                    console.log(`Creating user in Auth for email: ${email}`);
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    console.log('Auth user created successfully! UID:', user.uid);

                    // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firestore (‡πÉ‡∏ä‡πâ Batch Write)
                    console.log(`Writing user data to Firestore for UID: ${user.uid} and Username: ${username}`);
                    const batch = db.batch();
                    const userDocRef = db.collection('users').doc(user.uid);
                    batch.set(userDocRef, {
                        username: username,
                        email: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    batch.set(usernameRef, { // usernameRef ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1
                        userId: user.uid,
                        email: user.email // ‡πÄ‡∏Å‡πá‡∏ö email ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Login ‡∏î‡πâ‡∏ß‡∏¢ Username
                    });

                    // 4. Commit Batch Write
                    await batch.commit();
                    console.log('Firestore write successful!');

                    showToast(`‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${username}!`);
                    registerUsernameInput.value = '';
                    registerEmailInput.value = '';
                    registerPasswordInput.value = '';
                    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏≠‡∏á onAuthStateChanged ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ

                } catch (error) {
                    console.error('Registration failed:', error);
                    if (error.code && error.code.startsWith('auth/')) {
                        showAuthError(error.message);
                    } else {
                        showAuthError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                        // Consider adding cleanup logic if auth user was created but Firestore failed
                        if (auth.currentUser && auth.currentUser.email === email) {
                             console.warn("Auth user might have been created but Firestore write failed. Attempting to delete auth user.");
                             // Optionally try to delete the orphaned auth user
                             // await auth.currentUser.delete().catch(delErr => console.error("Failed to delete orphaned auth user", delErr));
                        }
                    }
                }
            });
        } else {
            console.error("Register button not found!");
        }


        // ======== Event Listener ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Login ========
        if (loginButton) {
            loginButton.addEventListener('click', async () => {
                if (!loginUsernameInput || !loginPasswordInput) {
                    console.error("Login form inputs not found!");
                    showAuthError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
                    return;
                }
                const usernameOrEmail = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value;
                if(authErrorDisplay) authErrorDisplay.textContent = '';

                if (!usernameOrEmail || !password) { showAuthError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username (‡∏´‡∏£‡∏∑‡∏≠ Email) ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"); return; }

                try {
                    let emailToLogin = usernameOrEmail;

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Username ‡∏´‡∏£‡∏∑‡∏≠ Email
                    if (!usernameOrEmail.includes('@')) {
                        const usernameLower = usernameOrEmail.toLowerCase();
                        console.log(`Input looks like username: ${usernameLower}. Querying Firestore...`);
                        const usernameRef = db.collection('usernames').doc(usernameLower);
                        const usernameDoc = await usernameRef.get();

                        if (usernameDoc.exists) {
                            emailToLogin = usernameDoc.data().email;
                            if (!emailToLogin) {
                                console.error(`Username ${usernameLower} found in Firestore but missing email field!`);
                                showAuthError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Username ‡∏ô‡∏µ‡πâ`); return;
                            }
                            console.log(`Username found! Corresponding email: ${emailToLogin}`);
                        } else {
                            console.log(`Username ${usernameLower} not found in Firestore.`);
                            // Try logging in with the input as email directly as a fallback,
                            // because the original code didn't explicitly prevent this.
                            // showAuthError(`Username not found`); return;
                            console.warn(`Username ${usernameLower} not found, attempting login with input as email.`);
                            emailToLogin = usernameOrEmail; // Keep original input if it wasn't found as username
                        }
                    } else {
                        console.log(`Input looks like email: ${emailToLogin}`);
                    }

                    // ‡πÉ‡∏ä‡πâ Email ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤ Login Auth
                    console.log(`Attempting Firebase Auth sign-in with email: ${emailToLogin}`);
                    const userCredential = await auth.signInWithEmailAndPassword(emailToLogin, password);
                    console.log('Login successful! User:', userCredential.user);

                    loginUsernameInput.value = '';
                    loginPasswordInput.value = '';
                    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏≠‡∏á onAuthStateChanged ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ

                } catch (error) {
                    console.error('Login failed:', error);
                     // Check specific error codes for better messages
                    if (error.code === 'auth/user-not-found' ||
                        error.code === 'auth/wrong-password' ||
                        error.code === 'auth/invalid-credential' || // Generic credential error
                        error.code === 'auth/invalid-email') {
                        showAuthError('Username (‡∏´‡∏£‡∏∑‡∏≠ Email) ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
                    } else if (error.code === 'auth/too-many-requests') {
                         showAuthError('‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
                    }
                    else {
                        showAuthError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô: ' + error.message);
                    }
                }
            });
        } else {
            console.error("Login button not found!");
        }


        // ======== Event Listener ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Logout ========
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                auth.signOut().then(() => {
                    console.log('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß!');
                    showToast('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    // onAuthStateChanged ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á container
                }).catch((error) => {
                    console.error('Logout Error:', error);
                    showAuthError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message);
                });
            });
        } else {
            console.error("Logout button not found!");
        }


        // ======== onAuthStateChanged (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Auth/App) ========
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // --- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà ---
                console.log('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà:', user.email, 'UID:', user.uid);
                let displayNameToShow = user.email; // Default to email

                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á Username ‡∏à‡∏≤‡∏Å Firestore
                try {
                    console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Firestore ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UID: ${user.uid}`);
                    const userDocRef = db.collection('users').doc(user.uid);
                    const userDoc = await userDocRef.get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        console.log('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Firestore:', userData);
                        if (userData.username) {
                            displayNameToShow = userData.username;
                            console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á username: ${displayNameToShow}`);
                        } else {
                            console.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå username ‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Firestore, ‡πÉ‡∏ä‡πâ email ‡πÅ‡∏ó‡∏ô');
                        }
                    } else {
                        console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UID ${user.uid} ‡πÉ‡∏ô Firestore! ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô user ‡πÄ‡∏Å‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£`);
                        // Consider creating the user document here if it's missing?
                    }
                } catch (error) {
                    console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Firestore:", error);
                    // Show email even if Firestore fetch fails
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö App
                if(userDisplay) userDisplay.textContent = `| ${displayNameToShow}`;
                if(authContainer) authContainer.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° Auth
                if(appContainer) appContainer.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á App ‡∏´‡∏•‡∏±‡∏Å (‡πÉ‡∏ä‡πâ flex)
                if(authErrorDisplay) authErrorDisplay.textContent = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÄ‡∏Å‡πà‡∏≤

            } else {
                // --- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ---
                console.log('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                if(authContainer) authContainer.style.display = 'block'; // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° Auth
                if(appContainer) appContainer.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô App ‡∏´‡∏•‡∏±‡∏Å
                if(userDisplay) userDisplay.textContent = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Spinner Inputs
                if (inputText) inputText.value = '';
                if (outputText) outputText.value = '';
                if (keywordInput) keywordInput.value = '';
                if (currentMode) {
                    document.querySelectorAll('.mode-btn.active').forEach(btn => btn.classList.remove('active'));
                    currentMode = null;
                    if (typeof updateUI === 'function') updateUI(); // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á keyword input
                }
                 // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Auth Forms
                if(loginUsernameInput) loginUsernameInput.value = '';
                if(loginPasswordInput) loginPasswordInput.value = '';
                if(registerUsernameInput) registerUsernameInput.value = '';
                if(registerEmailInput) registerEmailInput.value = '';
                if(registerPasswordInput) registerPasswordInput.value = '';
                if(authErrorDisplay) authErrorDisplay.textContent = ''; // ‡∏•‡πâ‡∏≤‡∏á error ‡∏î‡πâ‡∏ß‡∏¢
            }
        });


        // ######################################################################
        // ########   ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô Spinner (Core Logic - ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)             ########
        // ######################################################################

        const ALLOWED_CHARS = '‡∏Å‡∏Ç‡∏Ñ‡∏Ü‡∏á‡∏à‡∏â‡∏ä‡∏ã‡∏å‡∏ç‡∏é‡∏è‡∏ê‡∏ë‡∏í‡∏ì‡∏î‡∏ï‡∏ñ‡∏ó‡∏ò‡∏ô‡∏ö‡∏õ‡∏ú‡∏ù‡∏û‡∏ü‡∏†‡∏°‡∏¢‡∏£‡∏•‡∏ß‡∏®‡∏©‡∏™‡∏´‡∏¨‡∏≠‡∏Æ‡∏§‡πÜ‡∏∞‡∏±‡∏≤‡∏¥‡∏µ‡∏∂‡∏∑‡∏∏‡∏π‡πÄ‡πÅ‡πÇ‡πÉ‡πÑ‡πÖ‡∏≥‡πà‡πâ‡πä‡πãabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,./<>?‡πêŒ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâŒëŒíŒìŒîŒïŒñŒóŒòŒôŒöŒõŒúŒùŒûŒüŒ†Œ°Œ£Œ§Œ•Œ¶ŒßŒ®Œ©';
        const DEFAULT_KEYWORD = 'jornjud';
        const DEFAULT_PREFIX = '~';
        const SEED_LENGTH = 4;
        function generateShortSeed() { return Math.random().toString(36).slice(-SEED_LENGTH).padStart(SEED_LENGTH, '0'); }
        function createPRNG(seed) { const seedHash = [...seed].reduce((hash, ch) => (hash * 31 + ch.charCodeAt(0)) & 0x7fffffff, 0); let state = seedHash; return () => { state = (state * 1103515245 + 12345) & 0x7fffffff; return state / 0x80000000; }; }
        const pigpenEmojis = ['üòÄ','üòÅ','üòÇ','ü§£','üòÉ','üòÑ','üòÖ','üòÜ','üòâ','üòä', 'üòã','üòé','üòç','üòò','üòó','üòô','üòö','üôÇ','ü§ó','ü§©','ü§î','ü§®','üòê','üòë','üò∂','üôÑ','üòè','üò£','üò•','üòÆ', 'ü§ê','üòØ','üò™','üò´','üò¥','üòå','üòõ','üòú','üòù','ü§§','üòí','üòì','üòî','üòï','üôÉ','ü§ë','üò≤','‚òπÔ∏è','üôÅ','üòñ', 'üòû','üòü','üò§','üò¢','üò≠','üò¶','üòß','üò®','üò©','ü§Ø','üò¨','üò∞','üò±','ü•µ','ü•∂','üò≥','ü§™','üòµ','üò°','üò†', 'ü§¨','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','üòá','ü•∞','ü§†','ü§°','ü•≥','ü•¥','ü•∫','ü§•','ü§´','ü§≠','üßê','ü§ì','üòà', 'üëø','üëπ','üë∫','üíÄ','üëª','üëΩ','ü§ñ','üí©','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ','üê∂','üê±','üê≠', 'üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üêΩ','üê∏','üêµ','üôà','üôâ','üôä','üêí','üêî','üêß','üê¶', 'üê§','üê£','üê•','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ó','üï∑','üï∏', 'ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ', 'ü¶ì','ü¶ç','üêò','ü¶è','üê™','üê´','ü¶í','ü¶ò','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','üêê','üêì','ü¶É','üïä','üêá', 'üêÅ','üêÄ','üêø','ü¶î','üêæ','üêâ','üê≤','üåµ','üéÑ','üå≤','üå≥','üå¥','üå±','üåø','‚òòÔ∏è','üçÄ','üéç','üéã','üçÉ','üçÇ', 'üçÅ','üçÑ','üåæ','üíê','üå∑','üåπ','ü•Ä','üå∫','üå∏','üåº','üåª','üåû','üåù','üåõ','üåö','üåú','üåô','‚≠ê','üåü','üí´', '‚ú®','‚ö°','‚òÑÔ∏è','üí•','üî•','üå™','üåà','‚òÄÔ∏è','üå§','‚õÖ','üå•','‚òÅÔ∏è','üå¶','üåß','‚õà','üå©','üå®','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ', 'üå¨','üí®','üíß','üí¶','‚òî','‚òÇÔ∏è','üåä','üå´','üçè','üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçà','üçí','üçë', 'ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂','üåΩ','ü•ï','ü•î','üç†','ü•ê','üçû','ü•ñ','ü•®','üßÄ', 'ü•ö','üç≥','ü•û','ü•ì','ü•©','üçó','üçñ','üå≠','üçî','üçü','üçï','ü•™','ü•ô','üåÆ','üåØ','ü•ó','ü•ò','üçù','üçú','üç≤', 'üç•','•††','üç£','üç±','üçõ','üçö','üçô','üçò','üç¢','üç°','üçß','üç®','üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨', 'üç´','üçø','üç©','üç™','üå∞','ü•ú','üçØ','ü•õ','üçº','‚òï','üçµ','ü•§','üç∂','üç∫','üçª','ü•Ç','üç∑','ü•É','üç∏','üçπ', 'üçæ','ü•Ñ','üç¥','üçΩ','ü•£','ü•°','ü•¢','üöó','üöï','üöô','üöå','üöé','üèé','üöì','üöë','üöí','üöê','üöö','üöõ','üöú', 'üõ¥','üö≤','üõµ','üèç','üö®','üöî','üöç','üöò','üöñ','üö°','üö†','üöü','üöÉ','üöã','üöû','üöù','üöÑ','üöÖ','üöà','üöÇ', 'üöÜ','üöá','üöä','üöâ','‚úàÔ∏è','üõ´','üõ¨','üõ©','üí∫','üõ∞','üöÄ','üõ∏','üöÅ','üõ∂','‚õµ','üö§','üõ•','üõ≥','‚õ¥','üö¢', '‚öì','üöß','‚õΩ','üöè','üö¶','üö•','üó∫','üóø','üóΩ','‚õ≤','üóº','üè∞','üèØ','üé°','üé¢','üé†','‚õ±','üèñ','üèù','üåã', '‚õ∞','üèî','üóª','üèï','‚õ∫','üè†','üè°','üèò','üèö','üèó','üè≠','üè¢','üè¨','üè£','üè§','üè•','üè¶','üè®','üè™','üè´', 'üè©','üíí','üèõ','‚õ™','üïå','üïç','üïã','‚õ©','üõ§','üõ£','üóæ','üéë','üèû','üåÖ','üåÑ','üå†','üéá','üéÜ','üåá','üåÜ', 'üèô','üåÉ','üåå','üåâ','üåÅ'];
        const charToEmoji = new Map(); const emojiToChar = new Map();
        for (let i = 0; i < ALLOWED_CHARS.length && i < pigpenEmojis.length; i++) { charToEmoji.set(ALLOWED_CHARS[i], pigpenEmojis[i]); emojiToChar.set(pigpenEmojis[i], ALLOWED_CHARS[i]); }
        function encodeEmoji(text) { return [...text].map(ch => charToEmoji.get(ch) || ch).join(''); }
        function decodeEmoji(text) { const emojiArray = Array.from(text); return emojiArray.map(emoji => emojiToChar.get(emoji) || emoji).join(''); }
        function isAllEmoji(str) { const emojiArray = Array.from(str); return emojiArray.every(emoji => emojiToChar.has(emoji) || /\s/.test(emoji)); } // Allow whitespace
        function encodeWordspinner(text) { const chars = [...text]; const seed = generateShortSeed(); const prng = createPRNG(seed); const positions = chars.map((_, i) => i).sort(() => prng() - 0.5); const shuffledText = positions.map(pos => chars[pos]).join(''); return `${DEFAULT_PREFIX}${seed}${shuffledText}`; }
        function decodeWordspinner(text) { if (!text.startsWith(DEFAULT_PREFIX) || text.length < (DEFAULT_PREFIX.length + SEED_LENGTH)) return text; const seed = text.slice(DEFAULT_PREFIX.length, DEFAULT_PREFIX.length + SEED_LENGTH); const cipherText = text.slice(DEFAULT_PREFIX.length + SEED_LENGTH); if (cipherText.length === 0) return ''; const prng = createPRNG(seed); const positions = [...Array(cipherText.length).keys()].sort(() => prng() - 0.5); const reversePositions = new Array(cipherText.length); positions.forEach((shuffledIndex, originalIndex) => { reversePositions[shuffledIndex] = originalIndex; }); return reversePositions.map(pos => cipherText[pos]).join(''); }
        function isLikelyWordspinner(text) { return text.startsWith(DEFAULT_PREFIX) && text.length >= (DEFAULT_PREFIX.length + SEED_LENGTH); }
        function encodeThaiEng(text, keyword) { const seed = generateShortSeed(); const prng = createPRNG(seed + keyword); return seed + [...text].map(ch => { const idx = ALLOWED_CHARS.indexOf(ch); if (idx === -1) return ch; const randOffset = Math.floor(prng() * ALLOWED_CHARS.length); return ALLOWED_CHARS[(idx + randOffset) % ALLOWED_CHARS.length]; }).join(''); }
        function decodeThaiEng(encText, keyword) { if (!encText || encText.length < SEED_LENGTH) return encText; const seed = encText.slice(0, SEED_LENGTH); const cipherText = encText.slice(SEED_LENGTH); if (cipherText.length === 0) return ''; const prng = createPRNG(seed + keyword); return [...cipherText].map(ch => { const idx = ALLOWED_CHARS.indexOf(ch); if (idx === -1) return ch; const randOffset = Math.floor(prng() * ALLOWED_CHARS.length); return ALLOWED_CHARS[(idx - randOffset % ALLOWED_CHARS.length + ALLOWED_CHARS.length) % ALLOWED_CHARS.length]; }).join(''); }
        function isLikelyEncoded(text) { return /^[a-z0-9]{4}/.test(text) && text.length > SEED_LENGTH; } // Basic check for seed

        // ======== UI Update Function ========
        function updateUI() {
            if(keywordSection) {
                 keywordSection.style.display = (currentMode === 'xor') ? 'flex' : 'none';
            }
        }

        // ======== Process Input Based on Mode ========
        function processCurrentMode() {
            if (!auth.currentUser) {
                console.warn("User not logged in, cannot process.");
                // showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ", 3000, true); // Maybe too intrusive on every input
                return;
            }
            const text = inputText.value;
            let result = '';
            let action = '';

            if (text.trim() === '') {
                if(outputText) outputText.value = '';
                return; // Clear output if input is empty
            }

            if (!currentMode) {
                if(outputText) outputText.value = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô';
                showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô', 3000);
                return;
            }

            try {
                if (currentMode === 'xor') {
                    let key = keywordInput.value.trim() || DEFAULT_KEYWORD;
                    if (isLikelyEncoded(text)) {
                        action = 'üîë ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ (Key)...';
                        // showToast(action); // Can be annoying on every keystroke
                        result = decodeThaiEng(text, key);
                    } else {
                        action = 'üîí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ (Key)...';
                        // showToast(action);
                        result = encodeThaiEng(text.trim(), key);
                    }
                } else if (currentMode === 'wordspinner') {
                    if (isLikelyWordspinner(text)) {
                        action = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ (Spinner)...';
                        // showToast(action);
                        result = decodeWordspinner(text);
                    } else {
                        action = '‚ú® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ (Spinner)...';
                        // showToast(action);
                        result = encodeWordspinner(text.trim());
                    }
                } else if (currentMode === 'emoji') {
                    if (isAllEmoji(text)) {
                        action = 'üòÉ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ (Emoji)...';
                        // showToast(action);
                        result = decodeEmoji(text);
                    } else {
                        action = 'ü§™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ (Emoji)...';
                        // showToast(action);
                        result = encodeEmoji(text.trim());
                    }
                }
                if(outputText) outputText.value = result;
            } catch (error) {
                console.error("Processing Error:", error);
                showToast(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 4000, true);
                if(outputText) outputText.value = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!';
            }
        }

        // ======== Send Log Function (Optional) ========
        function sendLog(input, output, mode, keyword) {
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxkIJMiPz5HbBSDBKw-nmMvs3LPUa6RsR8AHtUoMMZcVpvHZbRhgGKYO62AoESBs8dufw/exec'; // <-- ‡∏ï‡∏£‡∏ß‡∏à URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏µ!
            const userIdentifier = auth.currentUser ? (auth.currentUser.email || auth.currentUser.uid) : 'anonymous';

            // Send log data (using no-cors mode, response might be opaque)
            fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ input: input, output: output, mode: mode, keyword: keyword, user: userIdentifier }),
                mode: 'no-cors' // Important for cross-origin requests to Apps Script without complex setup
            })
            .then(response => {
                console.log('Log request sent (status might be opaque due to no-cors).');
            })
            .catch(error => {
                console.error('Logging failed:', error);
                showToast('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Log', 3000, true);
            });
        }

        // ======== Event Listeners for App Elements ========

        // Mode Buttons
        [xorModeBtn, wordSpinnerModeBtn, emojiModeBtn].forEach(btn => {
            if(!btn) return;
            btn.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î", 3000, true);
                    return;
                }
                const newMode = btn.id.replace('ModeBtn', '').toLowerCase();
                if (currentMode !== newMode) {
                    currentMode = newMode;
                    updateUI(); // Show/hide keyword input
                    processCurrentMode(); // Process immediately on mode change

                    // Update active button style
                    document.querySelectorAll('.mode-btn.active').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    let modeName = '';
                    if (currentMode === 'xor') modeName = 'Key Translator';
                    else if (currentMode === 'wordspinner') modeName = 'Word Spinner';
                    else if (currentMode === 'emoji') modeName = 'Emoji Code';
                    showToast(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î ${modeName}`);
                }
            });
        });

        // Input Text Area (Real-time processing)
        if(inputText) {
            inputText.addEventListener('input', processCurrentMode);
        }

        // Keyword Input (Real-time processing for XOR mode)
        if(keywordInput) {
            keywordInput.addEventListener('input', () => {
                if (currentMode === 'xor' && auth.currentUser) {
                    processCurrentMode();
                }
            });
        }

        // Copy Button
        if(copyButton) {
            copyButton.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å", 3000, true);
                    return;
                }
                if (!outputText || !outputText.value) {
                    showToast('‚ùì ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 2000);
                    return;
                }

                const inputToLog = inputText.value.trim();
                const outputToLog = outputText.value;
                const modeToLog = currentMode;
                const keywordToLog = (currentMode === 'xor' && keywordInput) ? keywordInput.value.trim() : null; // Log keyword only for XOR

                navigator.clipboard.writeText(outputToLog).then(() => {
                    showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                    sendLog(inputToLog, outputToLog, modeToLog, keywordToLog); // Send log after successful copy
                }).catch(err => {
                    console.error('Clipboard API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ', err);
                    // Fallback for older browsers (less reliable)
                    try {
                        if(outputText) {
                            outputText.select();
                            outputText.setSelectionRange(0, 99999); // For mobile devices
                        }
                        if (document.execCommand('copy')) {
                            showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Å‡πà‡∏≤)');
                            sendLog(inputToLog, outputToLog, modeToLog, keywordToLog);
                        } else {
                            showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏Å‡∏î Ctrl+C ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏≠‡∏á');
                        }
                    } catch (execErr) {
                        console.error('‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Å‡πà‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', execErr);
                        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏Å‡∏î Ctrl+C ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏≠‡∏á');
                    }
                    // Deselect text after attempting copy
                    if (window.getSelection) { window.getSelection().removeAllRanges(); }
                    else if (document.selection) { document.selection.empty(); }
                });
            });
        }

        // Clear Button
        if(clearButton) {
            clearButton.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°", 3000, true);
                    return;
                }
                if(inputText) inputText.value = '';
                if(outputText) outputText.value = '';
                showToast('üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß');
                if(inputText) inputText.focus(); // Focus input after clearing
            });
        }

        // Help Modal Logic
        function showHelp() {
            if(!helpContent || !helpModal) return;
            // Populate help content dynamically
            helpContent.innerHTML = `
                <div class="pb-4 mb-4 border-b border-gray-600">
                    <h3 class="text-base font-semibold mb-2 flex items-center gap-2"><i class="fas fa-key text-blue-400"></i> Key Translator Mode</h3>
                    <p class="text-gray-300">‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞ Keyword (‡∏´‡∏≤‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <code>${DEFAULT_KEYWORD}</code>) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢ Keyword ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</p>
                </div>
                <div class="pb-4 mb-4 border-b border-gray-600">
                    <h3 class="text-base font-semibold mb-2 flex items-center gap-2"><i class="fas fa-smile text-yellow-400"></i> Emoji Code Mode</h3>
                    <p class="text-gray-300">‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (‡πÑ‡∏ó‡∏¢, ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç, ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß) ‡πÄ‡∏õ‡πá‡∏ô Emoji ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏õ‡∏•‡∏á Emoji ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™</p>
                </div>
                <div class="pb-4 mb-4 border-b border-gray-600">
                    <h3 class="text-base font-semibold mb-2 flex items-center gap-2"><i class="fas fa-sync-alt text-green-400"></i> Word Spinner Mode</h3>
                    <p class="text-gray-300">‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° Prefix <code>${DEFAULT_PREFIX}</code> ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™ Seed 4 ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Prefix ‡πÅ‡∏•‡∏∞ Seed ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°</p>
                </div>
                <p class="text-xs text-gray-400 italic text-center mt-4">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ üòâ</p>
            `;
            helpModal.style.display = 'block';
        }

        if(helpBtn) helpBtn.addEventListener('click', showHelp);
        if(closeBtn) closeBtn.addEventListener('click', () => { if(helpModal) helpModal.style.display = 'none'; });
        // Close modal if clicking outside the content
        window.addEventListener('click', (event) => {
            if (event.target === helpModal) {
                if(helpModal) helpModal.style.display = 'none';
            }
        });

        // Initial UI setup (e.g., hide keyword section)
        if (typeof updateUI === 'function') updateUI();

        console.log("‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå Spinner ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)");

        // --- Service Worker Registration (Optional but recommended for PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Assuming sw.js is in the same directory
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully with scope:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        } else {
            console.log('Service Worker is not supported by this browser.');
        }

    </script>

</body>
</html>
