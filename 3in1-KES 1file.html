<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3in1 Key-Emoji-Spinner (Dark Mode)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KZ1W13YWND"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KZ1W13YWND');
      // gtag('config', 'G-GRGVJ1V7BX'); // Measurement ID à¸ˆà¸²à¸ Firebase config
    </script>
    <style>
        /* Custom styles for toast and modal (can be refined further) */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevent pull-to-refresh */
        }
        .toast-notification {
            position: fixed;
            bottom: 20px; /* Adjusted for mobile */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(50, 50, 50, 0.9); /* Darker toast */
            color: #fff;
            padding: 10px 20px;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.9rem;
            z-index: 10000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            animation: fadeInOutToast 2.5s ease-in-out forwards;
            transition: opacity 0.3s ease;
        }
        .toast-notification.error {
             background-color: rgba(239, 68, 68, 0.9); /* Red for errors */
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            animation: fadeInModal 0.3s ease-out;
        }
        .modal-content {
            background-color: #2d3748; /* Dark background for modal */
            color: #e2e8f0; /* Light text */
            margin: 15% auto; /* Center vertically */
            padding: 20px;
            border-radius: 0.75rem; /* Rounded corners */
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: slideInModal 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .modal-content h2 { color: #63b3ed; } /* Light blue heading */
        #helpContent code { background-color: #4a5568; color: #fed7d7; padding: 2px 5px; border-radius: 4px; }
        #helpContent div { border-bottom: 1px solid #4a5568; }
        .close-btn {
            color: #a0aec0;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px; /* Slightly smaller */
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-btn:hover { color: #fff; }

        /* Animations */
        @keyframes fadeInModal { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideInModal { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        @keyframes fadeInOutToast {
            0% { opacity: 0; bottom: -50px; } /* Start from below */
            10% { opacity: 1; bottom: 20px; }
            90% { opacity: 1; bottom: 20px; }
            100% { opacity: 0; bottom: -50px; } /* Fade out downwards */
        }

        /* Tailwind Config (Optional: for custom theme colors if needed) */
        /*
        tailwind.config = {
          darkMode: 'class', // or 'media'
          theme: {
            extend: {
              colors: {
                // Define custom dark theme colors here
              }
            }
          }
        }
        */
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-full flex flex-col items-center justify-center p-4">

    <div id="auth-container" class="w-full max-w-md p-6 md:p-8 bg-gray-800 rounded-xl shadow-lg">
        <h1 class="text-xl md:text-2xl font-bold text-center text-blue-400 mb-2">ğŸ” à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸”à¸´à¸§à¸° à¹„à¸­à¹‰à¸ªà¸±à¸ª!ğŸ”</h1>
        <p class="text-center text-gray-400 text-sm mb-6">à¸•à¹‰à¸­à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸à¹ˆà¸­à¸™ à¸–à¸¶à¸‡à¸ˆà¸°à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸™à¸°à¸¡à¸¶à¸‡!</p>

        <div id="login-form" class="mb-6">
            <h2 class="text-lg font-semibold text-center mb-4 flex items-center justify-center gap-2"><i class="fas fa-user text-blue-400"></i> Login à¹„à¸­à¹‰à¸ªà¸±à¸ª!</h2>
            <div class="mb-4">
                <label for="login-username" class="block text-sm font-medium text-gray-300 mb-1">Username à¸«à¸£à¸·à¸­ Email:</label>
                <input type="text" id="login-username" placeholder="à¸à¸£à¸­à¸ Username à¸«à¸£à¸·à¸­ Email..." required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            <div class="mb-4">
                <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™:</label>
                <input type="password" id="login-password" placeholder="à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™..." required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 ease-in-out flex items-center justify-center gap-2 text-sm"><i class="fas fa-check"></i> à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸”à¸´à¹€à¸«à¸µà¹‰à¸¢!</button>
        </div>

        <hr class="border-gray-600 my-6">

        <div id="register-form">
            <h2 class="text-lg font-semibold text-center mb-4 flex items-center justify-center gap-2"><i class="fas fa-user-plus text-green-400"></i> à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¹ƒà¸«à¸¡à¹ˆà¹€à¸«à¸£à¸­à¸§à¸°?</h2>
            <div class="mb-4">
                <label for="register-username" class="block text-sm font-medium text-gray-300 mb-1">Username:</label>
                <input type="text" id="register-username" placeholder="à¸•à¸±à¹‰à¸‡ Username (à¸­à¸±à¸‡à¸à¸¤à¸©/à¹€à¸¥à¸‚, 3 à¸•à¸±à¸§à¸‚à¸¶à¹‰à¸™à¹„à¸›)" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
            </div>
            <div class="mb-4">
                <label for="register-email" class="block text-sm font-medium text-gray-300 mb-1">Email:</label>
                <input type="email" id="register-email" placeholder="à¸à¸£à¸­à¸à¸­à¸µà¹€à¸¡à¸¥ (à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸­à¸¢à¸¹à¹ˆà¸”à¸µà¸ªà¸±à¸ª!)" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
            </div>
            <div class="mb-4">
                <label for="register-password" class="block text-sm font-medium text-gray-300 mb-1">à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™:</label>
                <input type="password" id="register-password" placeholder="à¸•à¸±à¹‰à¸‡à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ (6 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¸‚à¸¶à¹‰à¸™à¹„à¸›)" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
            </div>
            <button id="register-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 ease-in-out flex items-center justify-center gap-2 text-sm"><i class="fas fa-plus-circle"></i> à¸ªà¸¡à¸±à¸„à¸£à¹‚à¸§à¹‰à¸¢!</button>
        </div>

        <p id="auth-error" class="text-red-400 text-center mt-4 font-semibold text-sm min-h-[1.2em]"></p>
    </div>

    <div id="app-container" class="w-full h-full max-w-3xl bg-gray-800 rounded-xl shadow-lg p-4 md:p-6 flex flex-col" style="display: none;">

        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <h1 class="text-lg md:text-xl font-bold text-center text-blue-400 flex-grow whitespace-nowrap">ğŸ” 3in1 Key-Emoji-Spinner ğŸ”</h1>
            <div class="flex items-center gap-2 flex-shrink-0">
                <span id="user-display" class="text-xs md:text-sm text-gray-400"></span>
                <button id="logout-button" class="p-2 rounded-full bg-red-600 hover:bg-red-700 text-white transition duration-200 text-xs" title="à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š"><i class="fas fa-sign-out-alt"></i></button>
                <button id="helpBtn" class="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition duration-200 text-xs" title="à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™"><i class="fas fa-question-circle"></i></button>
            </div>
        </div>

        <div class="mode-instruction text-center text-sm text-gray-400 mb-4 flex items-center justify-center gap-2">
            <i class="fas fa-hand-point-down text-blue-400"></i> à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸à¹ˆà¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
        </div>

        <div class="mode-buttons grid grid-cols-3 gap-2 md:gap-3 mb-4">
             <button id="xorModeBtn" class="mode-btn bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-2 px-3 rounded-lg transition duration-200 text-xs md:text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-center">
                <i class="fas fa-key"></i> <span class="whitespace-nowrap">Key Translator</span>
            </button>
             <button id="emojiModeBtn" class="mode-btn bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-2 px-3 rounded-lg transition duration-200 text-xs md:text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-center">
                <i class="fas fa-smile"></i> <span class="whitespace-nowrap">Emoji Code</span>
            </button>
             <button id="wordSpinnerModeBtn" class="mode-btn bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-2 px-3 rounded-lg transition duration-200 text-xs md:text-sm flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-center">
                <i class="fas fa-sync-alt"></i> <span class="whitespace-nowrap">Word Spinner</span>
            </button>
        </div>
        <style> /* Style for active button */
            .mode-btn.active { background-color: #2563eb; color: white; } /* Blue-600 */
        </style>

        <div id="keywordSection" class="keyword-section mb-4" style="display: none;">
            <label for="keywordInput" class="flex items-center gap-2 text-sm font-medium text-gray-300 whitespace-nowrap mr-2"><i class="fas fa-search"></i> Keyword:</label>
            <input type="text" id="keywordInput" placeholder="à¹ƒà¸ªà¹ˆà¸„à¸µà¸¢à¹Œà¹€à¸§à¸´à¸£à¹Œà¸”... à¸«à¸£à¸·à¸­à¹€à¸§à¹‰à¸™à¸§à¹ˆà¸²à¸‡à¹„à¸§à¹‰" class="flex-grow px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent text-sm" />
        </div>

        <div class="io-section flex flex-col gap-3 flex-grow min-h-0">
            <textarea id="inputText" placeholder="ğŸ“ à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ..." class="w-full flex-1 resize-none p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent text-sm min-h-[80px]"></textarea>
            <textarea id="outputText" placeholder="ğŸ“¤ à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸ˆà¸°à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ..." readonly class="w-full flex-1 resize-none p-3 bg-gray-600 border border-gray-500 rounded-md text-gray-300 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent text-sm min-h-[80px]"></textarea>
        </div>

        <div class="action-buttons grid grid-cols-2 gap-2 md:gap-3 mt-4">
            <button id="copyButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex items-center justify-center gap-2 text-sm"><i class="fas fa-copy"></i> à¸„à¸±à¸”à¸¥à¸­à¸</button>
            <button id="clearButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex items-center justify-center gap-2 text-sm"><i class="fas fa-trash"></i> à¸¥à¹‰à¸²à¸‡</button>
        </div>

        <div class="video-link text-center text-xs md:text-sm mt-4 text-gray-400">
            ğŸ“¹ <a href="https://www.youtube.com/watch?v=VIDEO_ID" target="_blank" class="text-blue-400 hover:text-blue-300 hover:underline">à¹€à¸£à¹‡à¸§à¹†à¸™à¸µà¹‰...à¸”à¸¹à¸§à¸´à¸”à¸µà¹‚à¸­à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸šà¸™ YouTube</a>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">Ã—</span>
            <h2 class="text-lg md:text-xl font-semibold text-center mb-4 flex items-center justify-center gap-2"><i class="fas fa-info-circle"></i> à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹à¸•à¹ˆà¸¥à¸°à¹‚à¸«à¸¡à¸” ğŸ¤“</h2>
            <div id="helpContent" class="text-sm space-y-4">
                </div>
        </div>
    </div>

    <script>
        // ======== Firebase Configuration ========
        const firebaseConfig = {
            apiKey: "AIzaSyB3ZXwlQlNPKEaryal0YnbarwQoz1DjhEE", // à¹€à¸Šà¹‡à¸„à¹ƒà¸«à¹‰à¸”à¸µà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ Key à¸‚à¸­à¸‡à¸¡à¸¶à¸‡à¸ˆà¸£à¸´à¸‡à¹†
            authDomain: "in1-e0d50.firebaseapp.com",
            projectId: "in1-e0d50",
            storageBucket: "in1-e0d50.appspot.com", // à¹€à¸Šà¹‡à¸„à¸­à¸±à¸™à¸™à¸µà¹‰à¸”à¹‰à¸§à¸¢
            messagingSenderId: "785769870882",
            appId: "1:785769870882:web:42df8ee3b40eced196bc7b",
            measurementId: "G-GRGVJ1V7BX"
        };

        // ======== Initialize Firebase ========
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log("Firebase & Firestore Initialized à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹‚à¸§à¹‰à¸¢!");

        // ======== Element References (Auth + App) ========
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const registerUsernameInput = document.getElementById('register-username');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const registerButton = document.getElementById('register-button');
        const logoutButton = document.getElementById('logout-button');
        const authErrorDisplay = document.getElementById('auth-error');
        const userDisplay = document.getElementById('user-display');
        const xorModeBtn = document.getElementById('xorModeBtn');
        const wordSpinnerModeBtn = document.getElementById('wordSpinnerModeBtn');
        const emojiModeBtn = document.getElementById('emojiModeBtn');
        const keywordSection = document.getElementById('keywordSection');
        const keywordInput = document.getElementById('keywordInput');
        const inputText = document.getElementById('inputText');
        const outputText = document.getElementById('outputText');
        const copyButton = document.getElementById('copyButton');
        const clearButton = document.getElementById('clearButton');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeBtn = helpModal.querySelector('.close-btn');
        const helpContent = document.getElementById('helpContent');

        let currentMode = null;
        let toastTimeout = null;

        // ======== à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡ Toast ========
        function showToast(message, duration = 2500, isError = false) {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) { clearTimeout(toastTimeout); existingToast.remove(); }
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'toast-notification';
            if (isError) { toast.classList.add('error'); } // à¹ƒà¸Šà¹‰ class 'error'
            document.body.appendChild(toast);

            // Force reflow to enable animation
            toast.offsetHeight;

            toast.style.opacity = '1'; // Make it visible for animation

            toastTimeout = setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                         toast.parentNode.removeChild(toast);
                    }
                }, 300); // Wait for fade out transition
            }, duration - 300);
        }


        // ======== à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡ Error à¸‚à¸­à¸‡ Auth ========
        function showAuthError(message) {
            let displayMessage = message;
            // à¹à¸›à¸¥à¸‡ Error codes à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢
            if (message.includes('auth/invalid-email')) { displayMessage = 'à¸£à¸¹à¸›à¹à¸šà¸šà¸­à¸µà¹€à¸¡à¸¥à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡'; }
            else if (message.includes('auth/user-not-found') || message.includes('auth/invalid-credential')) { displayMessage = 'Username (à¸«à¸£à¸·à¸­ Email) à¸«à¸£à¸·à¸­à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡'; }
            else if (message.includes('auth/wrong-password')) { displayMessage = 'à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡'; }
            else if (message.includes('auth/email-already-in-use')) { displayMessage = 'à¸­à¸µà¹€à¸¡à¸¥à¸™à¸µà¹‰à¸–à¸¹à¸à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§'; }
            else if (message.includes('auth/weak-password')) { displayMessage = 'à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸ªà¸±à¹‰à¸™à¸«à¸£à¸·à¸­à¸„à¸²à¸”à¹€à¸”à¸²à¸‡à¹ˆà¸²à¸¢à¹€à¸à¸´à¸™à¹„à¸› (à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 6 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£)'; }
            else if (message.includes('auth/missing-password')) { displayMessage = 'à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™'; }
            else if (message.includes('auth/missing-email')) { displayMessage = 'à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸­à¸µà¹€à¸¡à¸¥'; }
            else if (message.includes('Username check failed') || message.includes('Firestore write failed')) { displayMessage = 'à¹€à¸à¸´à¸”à¸›à¸±à¸à¸«à¸²à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Username à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡'; }
            else if (message.includes('Username already exists')) { displayMessage = `Username à¸™à¸µà¹‰à¸¡à¸µà¸„à¸™à¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§!`; }
            else if (message.includes('Username not found')) { displayMessage = `à¹„à¸¡à¹ˆà¸à¸š Username à¸™à¸µà¹‰à¹ƒà¸™à¸£à¸°à¸šà¸š!`; }
            else if (message.includes('Invalid Username format')) { displayMessage = `Username à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¹€à¸‰à¸à¸²à¸°à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© (a-z), à¸•à¸±à¸§à¹€à¸¥à¸‚ (0-9) à¹à¸¥à¸°à¸‚à¸µà¸”à¸¥à¹ˆà¸²à¸‡ (_) à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™`; }
            else if (message.includes('Username too short') || message.includes('Username too long')) { displayMessage = `Username à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸„à¸§à¸²à¸¡à¸¢à¸²à¸§ 3-30 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£`; }

            if(authErrorDisplay) authErrorDisplay.textContent = `ğŸš« ${displayMessage}`;
            showToast(`ğŸš« ${displayMessage}`, 4000, true); // à¹à¸ªà¸”à¸‡à¹€à¸›à¹‡à¸™ Toast à¸”à¹‰à¸§à¸¢
        }

        // ======== Event Listener à¸‚à¸­à¸‡à¸›à¸¸à¹ˆà¸¡ Register ========
        if (registerButton) {
            registerButton.addEventListener('click', async () => {
                if (!registerUsernameInput || !registerEmailInput || !registerPasswordInput) {
                    console.error("Register form inputs not found!");
                    showAuthError("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸à¸±à¸šà¸Ÿà¸­à¸£à¹Œà¸¡à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™");
                    return;
                }
                const username = registerUsernameInput.value.trim().toLowerCase();
                const email = registerEmailInput.value.trim();
                const password = registerPasswordInput.value;
                if(authErrorDisplay) authErrorDisplay.textContent = '';

                // Input Validation (à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡)
                if (!username || !email || !password) { showAuthError("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ Username, Email, à¹à¸¥à¸° Password à¹ƒà¸«à¹‰à¸„à¸£à¸šà¸–à¹‰à¸§à¸™"); return; }
                const usernameRegex = /^[a-z0-9_]+$/;
                if (!usernameRegex.test(username)) { showAuthError("Invalid Username format"); return; }
                if (username.length < 3 || username.length > 30) { showAuthError("Username too short or Username too long"); return; }
                if (password.length < 6) { showAuthError("auth/weak-password"); return; }

                try {
                    // 1. à¹€à¸Šà¹‡à¸„ Username à¸‹à¹‰à¸³à¹ƒà¸™ Firestore
                    console.log(`Checking username: ${username}`);
                    const usernameRef = db.collection('usernames').doc(username);
                    const usernameDoc = await usernameRef.get();
                    if (usernameDoc.exists) {
                        console.log(`Username ${username} already exists.`);
                        showAuthError(`Username already exists`); return;
                    }
                    console.log(`Username ${username} is available.`);

                    // 2. à¸ªà¸£à¹‰à¸²à¸‡ User à¹ƒà¸™ Firebase Auth
                    console.log(`Creating user in Auth for email: ${email}`);
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    console.log('Auth user created successfully! UID:', user.uid);

                    // 3. à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡ Firestore (à¹ƒà¸Šà¹‰ Batch Write)
                    console.log(`Writing user data to Firestore for UID: ${user.uid} and Username: ${username}`);
                    const batch = db.batch();
                    const userDocRef = db.collection('users').doc(user.uid);
                    batch.set(userDocRef, {
                        username: username,
                        email: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    batch.set(usernameRef, { // usernameRef à¸ˆà¸²à¸à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸—à¸µà¹ˆ 1
                        userId: user.uid,
                        email: user.email // à¹€à¸à¹‡à¸š email à¹„à¸§à¹‰à¸”à¹‰à¸§à¸¢à¹€à¸œà¸·à¹ˆà¸­ Login à¸”à¹‰à¸§à¸¢ Username
                    });

                    // 4. Commit Batch Write
                    await batch.commit();
                    console.log('Firestore write successful!');

                    showToast(`âœ… à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š ${username}!`);
                    registerUsernameInput.value = '';
                    registerEmailInput.value = '';
                    registerPasswordInput.value = '';
                    // à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸ªà¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸ˆà¸­à¹€à¸­à¸‡ onAuthStateChanged à¸ˆà¸°à¸ˆà¸±à¸”à¸à¸²à¸£à¹ƒà¸«à¹‰

                } catch (error) {
                    console.error('Registration failed:', error);
                    if (error.code && error.code.startsWith('auth/')) {
                        showAuthError(error.message);
                    } else {
                        showAuthError('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸šà¸²à¸‡à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸à¸²à¸£à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ à¹‚à¸›à¸£à¸”à¸¥à¸­à¸‡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡');
                        // Consider adding cleanup logic if auth user was created but Firestore failed
                        if (auth.currentUser && auth.currentUser.email === email) {
                             console.warn("Auth user might have been created but Firestore write failed. Attempting to delete auth user.");
                             // Optionally try to delete the orphaned auth user
                             // await auth.currentUser.delete().catch(delErr => console.error("Failed to delete orphaned auth user", delErr));
                        }
                    }
                }
            });
        } else {
            console.error("Register button not found!");
        }


        // ======== Event Listener à¸‚à¸­à¸‡à¸›à¸¸à¹ˆà¸¡ Login ========
        if (loginButton) {
            loginButton.addEventListener('click', async () => {
                if (!loginUsernameInput || !loginPasswordInput) {
                    console.error("Login form inputs not found!");
                    showAuthError("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸à¸±à¸šà¸Ÿà¸­à¸£à¹Œà¸¡à¸¥à¹‡à¸­à¸à¸­à¸´à¸™");
                    return;
                }
                const usernameOrEmail = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value;
                if(authErrorDisplay) authErrorDisplay.textContent = '';

                if (!usernameOrEmail || !password) { showAuthError("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ Username (à¸«à¸£à¸·à¸­ Email) à¹à¸¥à¸°à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™"); return; }

                try {
                    let emailToLogin = usernameOrEmail;

                    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ Username à¸«à¸£à¸·à¸­ Email
                    if (!usernameOrEmail.includes('@')) {
                        const usernameLower = usernameOrEmail.toLowerCase();
                        console.log(`Input looks like username: ${usernameLower}. Querying Firestore...`);
                        const usernameRef = db.collection('usernames').doc(usernameLower);
                        const usernameDoc = await usernameRef.get();

                        if (usernameDoc.exists) {
                            emailToLogin = usernameDoc.data().email;
                            if (!emailToLogin) {
                                console.error(`Username ${usernameLower} found in Firestore but missing email field!`);
                                showAuthError(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: à¹„à¸¡à¹ˆà¸à¸šà¸­à¸µà¹€à¸¡à¸¥à¸ªà¸³à¸«à¸£à¸±à¸š Username à¸™à¸µà¹‰`); return;
                            }
                            console.log(`Username found! Corresponding email: ${emailToLogin}`);
                        } else {
                            console.log(`Username ${usernameLower} not found in Firestore.`);
                            // Try logging in with the input as email directly as a fallback,
                            // because the original code didn't explicitly prevent this.
                            // showAuthError(`Username not found`); return;
                            console.warn(`Username ${usernameLower} not found, attempting login with input as email.`);
                            emailToLogin = usernameOrEmail; // Keep original input if it wasn't found as username
                        }
                    } else {
                        console.log(`Input looks like email: ${emailToLogin}`);
                    }

                    // à¹ƒà¸Šà¹‰ Email à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸¡à¸² Login Auth
                    console.log(`Attempting Firebase Auth sign-in with email: ${emailToLogin}`);
                    const userCredential = await auth.signInWithEmailAndPassword(emailToLogin, password);
                    console.log('Login successful! User:', userCredential.user);

                    loginUsernameInput.value = '';
                    loginPasswordInput.value = '';
                    // à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸ªà¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸ˆà¸­à¹€à¸­à¸‡ onAuthStateChanged à¸ˆà¸°à¸ˆà¸±à¸”à¸à¸²à¸£à¹ƒà¸«à¹‰

                } catch (error) {
                    console.error('Login failed:', error);
                     // Check specific error codes for better messages
                    if (error.code === 'auth/user-not-found' ||
                        error.code === 'auth/wrong-password' ||
                        error.code === 'auth/invalid-credential' || // Generic credential error
                        error.code === 'auth/invalid-email') {
                        showAuthError('Username (à¸«à¸£à¸·à¸­ Email) à¸«à¸£à¸·à¸­à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š');
                    } else if (error.code === 'auth/too-many-requests') {
                         showAuthError('à¸•à¸£à¸§à¸ˆà¸à¸šà¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸ªà¸‡à¸ªà¸±à¸¢ à¸¥à¸­à¸‡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡à¸ à¸²à¸¢à¸«à¸¥à¸±à¸‡');
                    }
                    else {
                        showAuthError('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¹‡à¸­à¸à¸­à¸´à¸™: ' + error.message);
                    }
                }
            });
        } else {
            console.error("Login button not found!");
        }


        // ======== Event Listener à¸‚à¸­à¸‡à¸›à¸¸à¹ˆà¸¡ Logout ========
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                auth.signOut().then(() => {
                    console.log('à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§!');
                    showToast('ğŸ‘‹ à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§');
                    // onAuthStateChanged à¸ˆà¸°à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¸‹à¹ˆà¸­à¸™/à¹à¸ªà¸”à¸‡ container
                }).catch((error) => {
                    console.error('Logout Error:', error);
                    showAuthError('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š: ' + error.message);
                });
            });
        } else {
            console.error("Logout button not found!");
        }


        // ======== onAuthStateChanged (à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥ Auth/App) ========
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // --- à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸­à¸¢à¸¹à¹ˆ ---
                console.log('à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸­à¸¢à¸¹à¹ˆ:', user.email, 'UID:', user.uid);
                let displayNameToShow = user.email; // Default to email

                // à¸à¸¢à¸²à¸¢à¸²à¸¡à¸”à¸¶à¸‡ Username à¸ˆà¸²à¸ Firestore
                try {
                    console.log(`à¸à¸³à¸¥à¸±à¸‡à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ˆà¸²à¸ Firestore à¸ªà¸³à¸«à¸£à¸±à¸š UID: ${user.uid}`);
                    const userDocRef = db.collection('users').doc(user.uid);
                    const userDoc = await userDocRef.get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        console.log('à¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸™ Firestore:', userData);
                        if (userData.username) {
                            displayNameToShow = userData.username;
                            console.log(`à¸à¸³à¸¥à¸±à¸‡à¹à¸ªà¸”à¸‡ username: ${displayNameToShow}`);
                        } else {
                            console.log('à¹„à¸¡à¹ˆà¸à¸šà¸Ÿà¸´à¸¥à¸”à¹Œ username à¹ƒà¸™à¹€à¸­à¸à¸ªà¸²à¸£ Firestore, à¹ƒà¸Šà¹‰ email à¹à¸—à¸™');
                        }
                    } else {
                        console.warn(`à¹„à¸¡à¹ˆà¸à¸šà¹€à¸­à¸à¸ªà¸²à¸£à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¸³à¸«à¸£à¸±à¸š UID ${user.uid} à¹ƒà¸™ Firestore! à¸­à¸²à¸ˆà¹€à¸›à¹‡à¸™ user à¹€à¸à¹ˆà¸² à¸«à¸£à¸·à¸­à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸•à¸­à¸™à¸ªà¸¡à¸±à¸„à¸£`);
                        // Consider creating the user document here if it's missing?
                    }
                } catch (error) {
                    console.error("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ˆà¸²à¸ Firestore:", error);
                    // Show email even if Firestore fetch fails
                }

                // à¸­à¸±à¸›à¹€à¸”à¸• UI à¸ªà¸³à¸«à¸£à¸±à¸š App
                if(userDisplay) userDisplay.textContent = `| ${displayNameToShow}`;
                if(authContainer) authContainer.style.display = 'none'; // à¸‹à¹ˆà¸­à¸™à¸Ÿà¸­à¸£à¹Œà¸¡ Auth
                if(appContainer) appContainer.style.display = 'flex'; // à¹à¸ªà¸”à¸‡ App à¸«à¸¥à¸±à¸ (à¹ƒà¸Šà¹‰ flex)
                if(authErrorDisplay) authErrorDisplay.textContent = ''; // à¸¥à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ error à¹€à¸à¹ˆà¸²

            } else {
                // --- à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸¥à¹‡à¸­à¸à¸­à¸´à¸™ ---
                console.log('à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§');
                if(authContainer) authContainer.style.display = 'block'; // à¹à¸ªà¸”à¸‡à¸Ÿà¸­à¸£à¹Œà¸¡ Auth
                if(appContainer) appContainer.style.display = 'none'; // à¸‹à¹ˆà¸­à¸™ App à¸«à¸¥à¸±à¸
                if(userDisplay) userDisplay.textContent = ''; // à¸¥à¹‰à¸²à¸‡à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰

                // à¸¥à¹‰à¸²à¸‡à¸„à¹ˆà¸²à¹ƒà¸™ Spinner Inputs
                if (inputText) inputText.value = '';
                if (outputText) outputText.value = '';
                if (keywordInput) keywordInput.value = '';
                if (currentMode) {
                    document.querySelectorAll('.mode-btn.active').forEach(btn => btn.classList.remove('active'));
                    currentMode = null;
                    if (typeof updateUI === 'function') updateUI(); // à¸‹à¹ˆà¸­à¸™/à¹à¸ªà¸”à¸‡ keyword input
                }
                 // à¸¥à¹‰à¸²à¸‡à¸„à¹ˆà¸²à¹ƒà¸™ Auth Forms
                if(loginUsernameInput) loginUsernameInput.value = '';
                if(loginPasswordInput) loginPasswordInput.value = '';
                if(registerUsernameInput) registerUsernameInput.value = '';
                if(registerEmailInput) registerEmailInput.value = '';
                if(registerPasswordInput) registerPasswordInput.value = '';
                if(authErrorDisplay) authErrorDisplay.textContent = ''; // à¸¥à¹‰à¸²à¸‡ error à¸”à¹‰à¸§à¸¢
            }
        });


        // ######################################################################
        // ########   à¹‚à¸„à¹‰à¸”à¸ªà¹ˆà¸§à¸™ Spinner (Core Logic - à¹„à¸¡à¹ˆà¹à¸à¹‰à¹„à¸‚)             ########
        // ######################################################################

        const ALLOWED_CHARS = 'à¸à¸‚à¸„à¸†à¸‡à¸ˆà¸‰à¸Šà¸‹à¸Œà¸à¸à¸à¸à¸‘à¸’à¸“à¸”à¸•à¸–à¸—à¸˜à¸™à¸šà¸›à¸œà¸à¸à¸Ÿà¸ à¸¡à¸¢à¸£à¸¥à¸§à¸¨à¸©à¸ªà¸«à¸¬à¸­à¸®à¸¤à¹†à¸°à¸±à¸²à¸´à¸µà¸¶à¸·à¸¸à¸¹à¹€à¹à¹‚à¹ƒà¹„à¹…à¸³à¹ˆà¹‰à¹Šà¹‹abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,./<>?à¹Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰Î‘Î’Î“Î”Î•Î–Î—Î˜Î™ÎšÎ›ÎœÎÎÎŸÎ Î¡Î£Î¤Î¥Î¦Î§Î¨Î©';
        const DEFAULT_KEYWORD = 'jornjud';
        const DEFAULT_PREFIX = '~';
        const SEED_LENGTH = 4;
        function generateShortSeed() { return Math.random().toString(36).slice(-SEED_LENGTH).padStart(SEED_LENGTH, '0'); }
        function createPRNG(seed) { const seedHash = [...seed].reduce((hash, ch) => (hash * 31 + ch.charCodeAt(0)) & 0x7fffffff, 0); let state = seedHash; return () => { state = (state * 1103515245 + 12345) & 0x7fffffff; return state / 0x80000000; }; }
        const pigpenEmojis = ['ğŸ˜€','ğŸ˜','ğŸ˜‚','ğŸ¤£','ğŸ˜ƒ','ğŸ˜„','ğŸ˜…','ğŸ˜†','ğŸ˜‰','ğŸ˜Š', 'ğŸ˜‹','ğŸ˜','ğŸ˜','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ™‚','ğŸ¤—','ğŸ¤©','ğŸ¤”','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ™„','ğŸ˜','ğŸ˜£','ğŸ˜¥','ğŸ˜®', 'ğŸ¤','ğŸ˜¯','ğŸ˜ª','ğŸ˜«','ğŸ˜´','ğŸ˜Œ','ğŸ˜›','ğŸ˜œ','ğŸ˜','ğŸ¤¤','ğŸ˜’','ğŸ˜“','ğŸ˜”','ğŸ˜•','ğŸ™ƒ','ğŸ¤‘','ğŸ˜²','â˜¹ï¸','ğŸ™','ğŸ˜–', 'ğŸ˜','ğŸ˜Ÿ','ğŸ˜¤','ğŸ˜¢','ğŸ˜­','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜©','ğŸ¤¯','ğŸ˜¬','ğŸ˜°','ğŸ˜±','ğŸ¥µ','ğŸ¥¶','ğŸ˜³','ğŸ¤ª','ğŸ˜µ','ğŸ˜¡','ğŸ˜ ', 'ğŸ¤¬','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ˜‡','ğŸ¥°','ğŸ¤ ','ğŸ¤¡','ğŸ¥³','ğŸ¥´','ğŸ¥º','ğŸ¤¥','ğŸ¤«','ğŸ¤­','ğŸ§','ğŸ¤“','ğŸ˜ˆ', 'ğŸ‘¿','ğŸ‘¹','ğŸ‘º','ğŸ’€','ğŸ‘»','ğŸ‘½','ğŸ¤–','ğŸ’©','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾','ğŸ¶','ğŸ±','ğŸ­', 'ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ½','ğŸ¸','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’','ğŸ”','ğŸ§','ğŸ¦', 'ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸ','ğŸœ','ğŸ¦—','ğŸ•·','ğŸ•¸', 'ğŸ¦‚','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦–','ğŸ¦•','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦€','ğŸ¡','ğŸ ','ğŸŸ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸŠ','ğŸ…','ğŸ†', 'ğŸ¦“','ğŸ¦','ğŸ˜','ğŸ¦','ğŸª','ğŸ«','ğŸ¦’','ğŸ¦˜','ğŸƒ','ğŸ‚','ğŸ„','ğŸ','ğŸ–','ğŸ','ğŸ‘','ğŸ','ğŸ“','ğŸ¦ƒ','ğŸ•Š','ğŸ‡', 'ğŸ','ğŸ€','ğŸ¿','ğŸ¦”','ğŸ¾','ğŸ‰','ğŸ²','ğŸŒµ','ğŸ„','ğŸŒ²','ğŸŒ³','ğŸŒ´','ğŸŒ±','ğŸŒ¿','â˜˜ï¸','ğŸ€','ğŸ','ğŸ‹','ğŸƒ','ğŸ‚', 'ğŸ','ğŸ„','ğŸŒ¾','ğŸ’','ğŸŒ·','ğŸŒ¹','ğŸ¥€','ğŸŒº','ğŸŒ¸','ğŸŒ¼','ğŸŒ»','ğŸŒ','ğŸŒ','ğŸŒ›','ğŸŒš','ğŸŒœ','ğŸŒ™','â­','ğŸŒŸ','ğŸ’«', 'âœ¨','âš¡','â˜„ï¸','ğŸ’¥','ğŸ”¥','ğŸŒª','ğŸŒˆ','â˜€ï¸','ğŸŒ¤','â›…','ğŸŒ¥','â˜ï¸','ğŸŒ¦','ğŸŒ§','â›ˆ','ğŸŒ©','ğŸŒ¨','â„ï¸','â˜ƒï¸','â›„', 'ğŸŒ¬','ğŸ’¨','ğŸ’§','ğŸ’¦','â˜”','â˜‚ï¸','ğŸŒŠ','ğŸŒ«','ğŸ','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸˆ','ğŸ’','ğŸ‘', 'ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸ…','ğŸ†','ğŸ¥‘','ğŸ¥¦','ğŸ¥¬','ğŸ¥’','ğŸŒ¶','ğŸŒ½','ğŸ¥•','ğŸ¥”','ğŸ ','ğŸ¥','ğŸ','ğŸ¥–','ğŸ¥¨','ğŸ§€', 'ğŸ¥š','ğŸ³','ğŸ¥','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸ¥ª','ğŸ¥™','ğŸŒ®','ğŸŒ¯','ğŸ¥—','ğŸ¥˜','ğŸ','ğŸœ','ğŸ²', 'ğŸ¥','ğ¥  ','ğŸ£','ğŸ±','ğŸ›','ğŸš','ğŸ™','ğŸ˜','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬', 'ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','â˜•','ğŸµ','ğŸ¥¤','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹', 'ğŸ¾','ğŸ¥„','ğŸ´','ğŸ½','ğŸ¥£','ğŸ¥¡','ğŸ¥¢','ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸ','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸšš','ğŸš›','ğŸšœ', 'ğŸ›´','ğŸš²','ğŸ›µ','ğŸ','ğŸš¨','ğŸš”','ğŸš','ğŸš˜','ğŸš–','ğŸš¡','ğŸš ','ğŸšŸ','ğŸšƒ','ğŸš‹','ğŸš','ğŸš','ğŸš„','ğŸš…','ğŸšˆ','ğŸš‚', 'ğŸš†','ğŸš‡','ğŸšŠ','ğŸš‰','âœˆï¸','ğŸ›«','ğŸ›¬','ğŸ›©','ğŸ’º','ğŸ›°','ğŸš€','ğŸ›¸','ğŸš','ğŸ›¶','â›µ','ğŸš¤','ğŸ›¥','ğŸ›³','â›´','ğŸš¢', 'âš“','ğŸš§','â›½','ğŸš','ğŸš¦','ğŸš¥','ğŸ—º','ğŸ—¿','ğŸ—½','â›²','ğŸ—¼','ğŸ°','ğŸ¯','ğŸ¡','ğŸ¢','ğŸ ','â›±','ğŸ–','ğŸ','ğŸŒ‹', 'â›°','ğŸ”','ğŸ—»','ğŸ•','â›º','ğŸ ','ğŸ¡','ğŸ˜','ğŸš','ğŸ—','ğŸ­','ğŸ¢','ğŸ¬','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸª','ğŸ«', 'ğŸ©','ğŸ’’','ğŸ›','â›ª','ğŸ•Œ','ğŸ•','ğŸ•‹','â›©','ğŸ›¤','ğŸ›£','ğŸ—¾','ğŸ‘','ğŸ','ğŸŒ…','ğŸŒ„','ğŸŒ ','ğŸ‡','ğŸ†','ğŸŒ‡','ğŸŒ†', 'ğŸ™','ğŸŒƒ','ğŸŒŒ','ğŸŒ‰','ğŸŒ'];
        const charToEmoji = new Map(); const emojiToChar = new Map();
        for (let i = 0; i < ALLOWED_CHARS.length && i < pigpenEmojis.length; i++) { charToEmoji.set(ALLOWED_CHARS[i], pigpenEmojis[i]); emojiToChar.set(pigpenEmojis[i], ALLOWED_CHARS[i]); }
        function encodeEmoji(text) { return [...text].map(ch => charToEmoji.get(ch) || ch).join(''); }
        function decodeEmoji(text) { const emojiArray = Array.from(text); return emojiArray.map(emoji => emojiToChar.get(emoji) || emoji).join(''); }
        function isAllEmoji(str) { const emojiArray = Array.from(str); return emojiArray.every(emoji => emojiToChar.has(emoji) || /\s/.test(emoji)); } // Allow whitespace
        function encodeWordspinner(text) { const chars = [...text]; const seed = generateShortSeed(); const prng = createPRNG(seed); const positions = chars.map((_, i) => i).sort(() => prng() - 0.5); const shuffledText = positions.map(pos => chars[pos]).join(''); return `${DEFAULT_PREFIX}${seed}${shuffledText}`; }
        function decodeWordspinner(text) { if (!text.startsWith(DEFAULT_PREFIX) || text.length < (DEFAULT_PREFIX.length + SEED_LENGTH)) return text; const seed = text.slice(DEFAULT_PREFIX.length, DEFAULT_PREFIX.length + SEED_LENGTH); const cipherText = text.slice(DEFAULT_PREFIX.length + SEED_LENGTH); if (cipherText.length === 0) return ''; const prng = createPRNG(seed); const positions = [...Array(cipherText.length).keys()].sort(() => prng() - 0.5); const reversePositions = new Array(cipherText.length); positions.forEach((shuffledIndex, originalIndex) => { reversePositions[shuffledIndex] = originalIndex; }); return reversePositions.map(pos => cipherText[pos]).join(''); }
        function isLikelyWordspinner(text) { return text.startsWith(DEFAULT_PREFIX) && text.length >= (DEFAULT_PREFIX.length + SEED_LENGTH); }
        function encodeThaiEng(text, keyword) { const seed = generateShortSeed(); const prng = createPRNG(seed + keyword); return seed + [...text].map(ch => { const idx = ALLOWED_CHARS.indexOf(ch); if (idx === -1) return ch; const randOffset = Math.floor(prng() * ALLOWED_CHARS.length); return ALLOWED_CHARS[(idx + randOffset) % ALLOWED_CHARS.length]; }).join(''); }
        function decodeThaiEng(encText, keyword) { if (!encText || encText.length < SEED_LENGTH) return encText; const seed = encText.slice(0, SEED_LENGTH); const cipherText = encText.slice(SEED_LENGTH); if (cipherText.length === 0) return ''; const prng = createPRNG(seed + keyword); return [...cipherText].map(ch => { const idx = ALLOWED_CHARS.indexOf(ch); if (idx === -1) return ch; const randOffset = Math.floor(prng() * ALLOWED_CHARS.length); return ALLOWED_CHARS[(idx - randOffset % ALLOWED_CHARS.length + ALLOWED_CHARS.length) % ALLOWED_CHARS.length]; }).join(''); }
        function isLikelyEncoded(text) { return /^[a-z0-9]{4}/.test(text) && text.length > SEED_LENGTH; } // Basic check for seed

        // ======== UI Update Function ========
        function updateUI() {
            if(keywordSection) {
                 keywordSection.style.display = (currentMode === 'xor') ? 'flex' : 'none';
            }
        }

        // ======== Process Input Based on Mode ========
        function processCurrentMode() {
            if (!auth.currentUser) {
                console.warn("User not logged in, cannot process.");
                // showToast("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸™à¸µà¹‰", 3000, true); // Maybe too intrusive on every input
                return;
            }
            const text = inputText.value;
            let result = '';
            let action = '';

            if (text.trim() === '') {
                if(outputText) outputText.value = '';
                return; // Clear output if input is empty
            }

            if (!currentMode) {
                if(outputText) outputText.value = 'âš ï¸ à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”à¸à¹ˆà¸­à¸™';
                showToast('âš ï¸ à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”à¸à¹ˆà¸­à¸™', 3000);
                return;
            }

            try {
                if (currentMode === 'xor') {
                    let key = keywordInput.value.trim() || DEFAULT_KEYWORD;
                    if (isLikelyEncoded(text)) {
                        action = 'ğŸ”‘ à¸à¸³à¸¥à¸±à¸‡à¸–à¸­à¸”à¸£à¸«à¸±à¸ª (Key)...';
                        // showToast(action); // Can be annoying on every keystroke
                        result = decodeThaiEng(text, key);
                    } else {
                        action = 'ğŸ”’ à¸à¸³à¸¥à¸±à¸‡à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ª (Key)...';
                        // showToast(action);
                        result = encodeThaiEng(text.trim(), key);
                    }
                } else if (currentMode === 'wordspinner') {
                    if (isLikelyWordspinner(text)) {
                        action = 'ğŸ”„ à¸à¸³à¸¥à¸±à¸‡à¸–à¸­à¸”à¸£à¸«à¸±à¸ª (Spinner)...';
                        // showToast(action);
                        result = decodeWordspinner(text);
                    } else {
                        action = 'âœ¨ à¸à¸³à¸¥à¸±à¸‡à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ª (Spinner)...';
                        // showToast(action);
                        result = encodeWordspinner(text.trim());
                    }
                } else if (currentMode === 'emoji') {
                    if (isAllEmoji(text)) {
                        action = 'ğŸ˜ƒ à¸à¸³à¸¥à¸±à¸‡à¸–à¸­à¸”à¸£à¸«à¸±à¸ª (Emoji)...';
                        // showToast(action);
                        result = decodeEmoji(text);
                    } else {
                        action = 'ğŸ¤ª à¸à¸³à¸¥à¸±à¸‡à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ª (Emoji)...';
                        // showToast(action);
                        result = encodeEmoji(text.trim());
                    }
                }
                if(outputText) outputText.value = result;
            } catch (error) {
                console.error("Processing Error:", error);
                showToast(`âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${error.message}`, 4000, true);
                if(outputText) outputText.value = 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”!';
            }
        }

        // ======== Send Log Function (Optional) ========
        function sendLog(input, output, mode, keyword) {
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxkIJMiPz5HbBSDBKw-nmMvs3LPUa6RsR8AHtUoMMZcVpvHZbRhgGKYO62AoESBs8dufw/exec'; // <-- à¸•à¸£à¸§à¸ˆ URL à¸™à¸µà¹‰à¹ƒà¸«à¹‰à¸”à¸µ!
            const userIdentifier = auth.currentUser ? (auth.currentUser.email || auth.currentUser.uid) : 'anonymous';

            // Send log data (using no-cors mode, response might be opaque)
            fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ input: input, output: output, mode: mode, keyword: keyword, user: userIdentifier }),
                mode: 'no-cors' // Important for cross-origin requests to Apps Script without complex setup
            })
            .then(response => {
                console.log('Log request sent (status might be opaque due to no-cors).');
            })
            .catch(error => {
                console.error('Logging failed:', error);
                showToast('âš ï¸ à¹€à¸à¸´à¸”à¸›à¸±à¸à¸«à¸²à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡ Log', 3000, true);
            });
        }

        // ======== Event Listeners for App Elements ========

        // Mode Buttons
        [xorModeBtn, wordSpinnerModeBtn, emojiModeBtn].forEach(btn => {
            if(!btn) return;
            btn.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showToast("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸à¹ˆà¸­à¸™à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹‚à¸«à¸¡à¸”", 3000, true);
                    return;
                }
                const newMode = btn.id.replace('ModeBtn', '').toLowerCase();
                if (currentMode !== newMode) {
                    currentMode = newMode;
                    updateUI(); // Show/hide keyword input
                    processCurrentMode(); // Process immediately on mode change

                    // Update active button style
                    document.querySelectorAll('.mode-btn.active').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    let modeName = '';
                    if (currentMode === 'xor') modeName = 'Key Translator';
                    else if (currentMode === 'wordspinner') modeName = 'Word Spinner';
                    else if (currentMode === 'emoji') modeName = 'Emoji Code';
                    showToast(`âœ… à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™à¹‚à¸«à¸¡à¸” ${modeName}`);
                }
            });
        });

        // Input Text Area (Real-time processing)
        if(inputText) {
            inputText.addEventListener('input', processCurrentMode);
        }

        // Keyword Input (Real-time processing for XOR mode)
        if(keywordInput) {
            keywordInput.addEventListener('input', () => {
                if (currentMode === 'xor' && auth.currentUser) {
                    processCurrentMode();
                }
            });
        }

        // Copy Button
        if(copyButton) {
            copyButton.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showToast("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸à¹ˆà¸­à¸™à¸„à¸±à¸”à¸¥à¸­à¸", 3000, true);
                    return;
                }
                if (!outputText || !outputText.value) {
                    showToast('â“ à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸«à¹‰à¸„à¸±à¸”à¸¥à¸­à¸', 2000);
                    return;
                }

                const inputToLog = inputText.value.trim();
                const outputToLog = outputText.value;
                const modeToLog = currentMode;
                const keywordToLog = (currentMode === 'xor' && keywordInput) ? keywordInput.value.trim() : null; // Log keyword only for XOR

                navigator.clipboard.writeText(outputToLog).then(() => {
                    showToast('ğŸ“‹ à¸„à¸±à¸”à¸¥à¸­à¸à¹„à¸›à¸¢à¸±à¸‡à¸„à¸¥à¸´à¸›à¸šà¸­à¸£à¹Œà¸”à¹à¸¥à¹‰à¸§');
                    sendLog(inputToLog, outputToLog, modeToLog, keywordToLog); // Send log after successful copy
                }).catch(err => {
                    console.error('Clipboard API à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: ', err);
                    // Fallback for older browsers (less reliable)
                    try {
                        if(outputText) {
                            outputText.select();
                            outputText.setSelectionRange(0, 99999); // For mobile devices
                        }
                        if (document.execCommand('copy')) {
                            showToast('ğŸ“‹ à¸„à¸±à¸”à¸¥à¸­à¸à¹„à¸›à¸¢à¸±à¸‡à¸„à¸¥à¸´à¸›à¸šà¸­à¸£à¹Œà¸”à¹à¸¥à¹‰à¸§ (à¸§à¸´à¸˜à¸µà¹€à¸à¹ˆà¸²)');
                            sendLog(inputToLog, outputToLog, modeToLog, keywordToLog);
                        } else {
                            showToast('âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸±à¸”à¸¥à¸­à¸à¹„à¸”à¹‰ à¸¥à¸­à¸‡à¸à¸” Ctrl+C à¸«à¸£à¸·à¸­à¹€à¸¥à¸·à¸­à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸­à¸‡');
                        }
                    } catch (execErr) {
                        console.error('à¸à¸²à¸£à¸„à¸±à¸”à¸¥à¸­à¸à¸§à¸´à¸˜à¸µà¹€à¸à¹ˆà¸²à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§', execErr);
                        showToast('âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸±à¸”à¸¥à¸­à¸à¹„à¸”à¹‰ à¸¥à¸­à¸‡à¸à¸” Ctrl+C à¸«à¸£à¸·à¸­à¹€à¸¥à¸·à¸­à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸­à¸‡');
                    }
                    // Deselect text after attempting copy
                    if (window.getSelection) { window.getSelection().removeAllRanges(); }
                    else if (document.selection) { document.selection.empty(); }
                });
            });
        }

        // Clear Button
        if(clearButton) {
            clearButton.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showToast("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸à¹ˆà¸­à¸™à¸¥à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡", 3000, true);
                    return;
                }
                if(inputText) inputText.value = '';
                if(outputText) outputText.value = '';
                showToast('ğŸ§¹ à¸¥à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸¥à¹‰à¸§');
                if(inputText) inputText.focus(); // Focus input after clearing
            });
        }

        // Help Modal Logic
        function showHelp() {
            if(!helpContent || !helpModal) return;
            // Populate help content dynamically
            helpContent.innerHTML = `
                <div class="pb-4 mb-4 border-b border-gray-600">
                    <h3 class="text-base font-semibold mb-2 flex items-center gap-2"><i class="fas fa-key text-blue-400"></i> Key Translator Mode</h3>
                    <p class="text-gray-300">à¹ƒà¸ªà¹ˆà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸¥à¸° Keyword (à¸«à¸²à¸à¹€à¸§à¹‰à¸™à¸§à¹ˆà¸²à¸‡à¸ˆà¸°à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ <code>${DEFAULT_KEYWORD}</code>) à¸£à¸°à¸šà¸šà¸ˆà¸°à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ª à¸«à¸²à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸›à¹‰à¸­à¸™à¸”à¸¹à¹€à¸«à¸¡à¸·à¸­à¸™à¸–à¸¹à¸à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ªà¹à¸¥à¹‰à¸§ à¸£à¸°à¸šà¸šà¸ˆà¸°à¸à¸¢à¸²à¸¢à¸²à¸¡à¸–à¸­à¸”à¸£à¸«à¸±à¸ªà¸”à¹‰à¸§à¸¢ Keyword à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™</p>
                </div>
                <div class="pb-4 mb-4 border-b border-gray-600">
                    <h3 class="text-base font-semibold mb-2 flex items-center gap-2"><i class="fas fa-smile text-yellow-400"></i> Emoji Code Mode</h3>
                    <p class="text-gray-300">à¹à¸›à¸¥à¸‡à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£ (à¹„à¸—à¸¢, à¸­à¸±à¸‡à¸à¸¤à¸©, à¸•à¸±à¸§à¹€à¸¥à¸‚, à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œà¸šà¸²à¸‡à¸•à¸±à¸§) à¹€à¸›à¹‡à¸™ Emoji à¸«à¸£à¸·à¸­à¹à¸›à¸¥à¸‡ Emoji à¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸”à¸´à¸¡ à¸£à¸°à¸šà¸šà¸ˆà¸°à¸„à¸²à¸”à¹€à¸”à¸²à¹‚à¸”à¸¢à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸§à¹ˆà¸²à¸„à¸§à¸£à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ªà¸«à¸£à¸·à¸­à¸–à¸­à¸”à¸£à¸«à¸±à¸ª</p>
                </div>
                <div class="pb-4 mb-4 border-b border-gray-600">
                    <h3 class="text-base font-semibold mb-2 flex items-center gap-2"><i class="fas fa-sync-alt text-green-400"></i> Word Spinner Mode</h3>
                    <p class="text-gray-300">à¸ªà¸¥à¸±à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸šà¸šà¸ªà¸¸à¹ˆà¸¡ à¸à¸£à¹‰à¸­à¸¡à¹€à¸à¸´à¹ˆà¸¡ Prefix <code>${DEFAULT_PREFIX}</code> à¹à¸¥à¸°à¸£à¸«à¸±à¸ª Seed 4 à¸•à¸±à¸§à¸—à¸µà¹ˆà¸”à¹‰à¸²à¸™à¸«à¸™à¹‰à¸² à¸«à¸²à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸›à¹‰à¸­à¸™à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ Prefix à¹à¸¥à¸° Seed à¸£à¸°à¸šà¸šà¸ˆà¸°à¸–à¸­à¸”à¸£à¸«à¸±à¸ªà¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸”à¸´à¸¡</p>
                </div>
                <p class="text-xs text-gray-400 italic text-center mt-4">à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸à¹ˆà¸­à¸™à¸ˆà¸¶à¸‡à¸ˆà¸°à¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹‚à¸«à¸¡à¸”à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰à¹„à¸”à¹‰ ğŸ˜‰</p>
            `;
            helpModal.style.display = 'block';
        }

        if(helpBtn) helpBtn.addEventListener('click', showHelp);
        if(closeBtn) closeBtn.addEventListener('click', () => { if(helpModal) helpModal.style.display = 'none'; });
        // Close modal if clicking outside the content
        window.addEventListener('click', (event) => {
            if (event.target === helpModal) {
                if(helpModal) helpModal.style.display = 'none';
            }
        });

        // Initial UI setup (e.g., hide keyword section)
        if (typeof updateUI === 'function') updateUI();

        console.log("à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œ Spinner à¹‚à¸«à¸¥à¸”à¹à¸¥à¸°à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ (à¸£à¸­à¸à¸²à¸£à¸¥à¹‡à¸­à¸à¸­à¸´à¸™)");

        // --- Service Worker Registration (Optional but recommended for PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Assuming sw.js is in the same directory
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully with scope:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        } else {
            console.log('Service Worker is not supported by this browser.');
        }

    </script>

</body>
</html>
